
ALTER PROCEDURE [dbo].[deleteOrderDetail] (@orderDetailId int,@actionPeformerId int,@referenceId varchar(250)) 
AS 
BEGIN
        --Archive all order items
        INSERT INTO OrderItems_Archive (
            [Archive_Id]
            ,[Quantity]
            ,[Created_At]
            ,[Modified_At]
            ,[OrderDetailId]
            ,[ProductId]
            ,[Action]
            ,[Peformed_At]
            ,[PeformedById]
            ,[Record_Type]
            ,[Reference_Id]
        ) 
        SELECT 
            [Id]
            ,[Quantity]
            ,[Created_At]
            ,[Modified_At]
            ,[OrderDetailsId]
            ,[ProductId],
            'DELETE' Actions,
            GETDATE() Peformed_At,
           @actionPeformerId,
            'delete' Record_Type
           ,@referenceId 

        FROM OrderItems WHERE OrderDetailsId = @orderDetailId



        -- Archive all order details
        INSERT INTO OrderDetails_Archive (       
            [Archive_Id]
            ,[Total]
            ,[Created_At]
            ,[Modified_At]
            ,[UserId]
            ,[PaymentDetailsId]
            ,[Status]
            ,[Action]
            ,[Peformed_At]
            ,[PeformedById]
            
            ,[Record_Type]
            ,[Reference_Id]
        )
        SELECT 
                [Id]
            ,[Total]
            ,[Created_At]
            ,[Modified_At]
            ,[UserId]
            ,[PaymentDetailsId]
            ,[Status],
            'DELETE' [Action],
            GETDATE(),
            @actionPeformerId,
            'delete' [Record_Type],
            @referenceId

        FROM OrderDetails WHERE Id = @orderDetailId
      
    --DELETE FROM OrderItems WHERE OrderDetailsId = @orderDetailId;
   -- DELETE FROM OrderDetails WHERE Id = @orderDetailId;
END;

-- EXEC dbo.deleteOrderDetail @orderDetailId = 4,@actionPeformerId = 1,@referenceId ='126326gewttyghsdghhvhgsvdhjjhdshj';
-- DELETE FROM OrderItems WHERE OrderDetailsId = 4;
-- DELETE FROM OrderDetails WHERE Id = 4;

